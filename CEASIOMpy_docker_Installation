# With this Dockerfile, you are building a Docker image for
# your LOCAL CEASIOMpy on CentOS 8, with system dependencies and Miniconda.
# Use the commands below to build the Docker image,
# and then to run the Docker container.

# docker build -t ceasiompy:local -f CEASIOMpy_docker_Installation .

# On Apple Silicon (ARM), it might be necessary to specify the processor architecture:
# docker build --platform=linux/amd64 -t ceasiompy:local -f CEASIOMpy_docker_Installation .

# docker run -it --rm -e DISPLAY=$DISPLAY -e LIBGL_ALWAYS_SOFTWARE=1 -v /tmp/.X11-unix:/tmp/.X11-unix -v /home/cfse2/Leon/DockerCEASIOMpy/CEASIOMpy:/CEASIOMpy ceasiompy:local


FROM centos:8

# Update CentOS repositories and install system dependencies
RUN sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-* && \
    sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-* && \
    dnf -y install git curl wget sudo unzip gcc-c++ tbb libXrender libXcursor libXinerama libXft

# Use bash as the default shell
SHELL ["/bin/bash", "--login", "-c"]

ENV CONDA_DIR=/opt/conda
RUN wget --quiet https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O ~/miniconda.sh && \
    /bin/bash ~/miniconda.sh -b -p /opt/conda
ENV PATH=$CONDA_DIR/bin:$PATH

WORKDIR /CEASIOMpy

# Create the necessary directory structure
WORKDIR /CEASIOMpy/installation/CentOS/

# Download only the required installation scripts
RUN wget https://raw.githubusercontent.com/cfsengineering/CEASIOMpy/main/installation/CentOS/install_pyavl.sh && \
    wget https://raw.githubusercontent.com/cfsengineering/CEASIOMpy/main/installation/CentOS/install_su2.sh

# Make the scripts executable
RUN chmod +x install_*.sh

# Run the installation scripts
RUN ./install_pyavl.sh
RUN ./install_su2.sh

# Go from /CEASIOMpy/INSTALLDIR to /INSTALLDIR
RUN mkdir -p /INSTALLDIR && \
    mv /CEASIOMpy/INSTALLDIR/* /INSTALLDIR/ && \
    rm -rf /CEASIOMpy/INSTALLDIR

# Install xvfb for graphical display
RUN dnf -y install xorg-x11-server-Xvfb
RUN dnf -y install mesa-libGL mesa-libGLU mesa-dri-drivers libXt
RUN dnf -y install mesa-libEGL mesa-libOSMesa

# Install system dependencies
RUN dnf -y install gcc-c++ tbb libXrender libXcursor libXinerama libXft libXt mesa-libGL mesa-libGLU mesa-libEGL mesa-libOSMesa xorg-x11-server-Xvfb

# Set the DISPLAY environment variable
ENV DISPLAY=:99
ENV LIBGL_ALWAYS_SOFTWARE=1

# Error rendering
ENV XDG_RUNTIME_DIR=/tmp/runtime-root
RUN mkdir -p /tmp/runtime-root && chmod 700 /tmp/runtime-root

# Initialize Conda for the shell
RUN $CONDA_DIR/bin/conda init bash && \
    echo "source $CONDA_DIR/etc/profile.d/conda.sh" >> ~/.bashrc

# Create an empty folder for mounting
RUN mkdir -p /CEASIOMpy

# Set the working directory to the mounted CEASIOMpy folder
WORKDIR /CEASIOMpy

# Get the required files for installing the conda environment
RUN wget https://raw.githubusercontent.com/cfsengineering/CEASIOMpy/main/setup.py -O /CEASIOMpy/setup.py && \
    wget https://raw.githubusercontent.com/cfsengineering/CEASIOMpy/main/pyproject.toml -O /CEASIOMpy/pyproject.toml && \
    wget https://raw.githubusercontent.com/cfsengineering/CEASIOMpy/main/environment.yml -O /CEASIOMpy/environment.yml && \
    wget https://raw.githubusercontent.com/cfsengineering/CEASIOMpy/main/README.md -O /CEASIOMpy/README.md && \
    wget https://raw.githubusercontent.com/cfsengineering/CEASIOMpy/main/LICENSE -O /CEASIOMpy/LICENSE

# Ensure the directory structure exists
RUN mkdir -p /CEASIOMpy/src

COPY src /CEASIOMpy/src

# Create the Conda environment from the environment.yml file
RUN source $CONDA_DIR/etc/profile.d/conda.sh && \
    conda env create -f environment.yml

# Activate the Conda environment and install CEASIOMpy
RUN source $CONDA_DIR/etc/profile.d/conda.sh && \
    conda activate ceasiompy && \
    pip install -e .

# Automatically activate the Conda environment in new shells
RUN echo "source $CONDA_DIR/etc/profile.d/conda.sh" >> ~/.bashrc && \
    echo "conda activate ceasiompy" >> ~/.bashrc && \
    echo "ceasiompy_run --gui" >> ~/.bashrc

# Move the content of /INSTALLDIR to the mounted /CEASIOMpy/INSTALLDIR folder at runtime
CMD ["/bin/bash", "-c", "rm -rf /CEASIOMpy/INSTALLDIR && mkdir -p /CEASIOMpy/INSTALLDIR && mv /INSTALLDIR/* /CEASIOMpy/INSTALLDIR/ && exec bash"]

# Now you just need click on: Networ URL

# If you did not have the necessary permissions:
# Run the following command to add your user to the docker group:

# sudo usermod -aG docker $USER

# Then, use the following command to apply the group change:

# newgrp docker
