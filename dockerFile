# With this Dockerfile, you are building a Docker image for
# your LOCAL CEASIOMpy on Ubuntu latest, with system dependencies and Miniconda.
# Use the commands below to build the Docker image,
# and then to run the Docker container.

FROM ubuntu:24.04

RUN apt-get update
RUN apt-get install -y libglu1-mesa-dev
RUN apt update && apt upgrade -y
RUN apt-get install -y apt-utils 
RUN apt-get install -y --no-install-recommends \
    git curl wget sudo unzip build-essential libtbbmalloc2 libtbb-dev libxrender1 libxcursor1 libxinerama1 libxft2 libxt6 \
    libgl1 libglu1-mesa libegl1 libosmesa6 xvfb ca-certificates && \
    rm -rf /var/lib/apt/lists/*

RUN apt-get update && apt-get install -y gnupg curl && \
    echo '#!/bin/sh\nexit 0' > /usr/sbin/policy-rc.d && chmod +x /usr/sbin/policy-rc.d

# Install Miniconda
ENV CONDA_DIR=/opt/conda
RUN curl -fsSL https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh -o /tmp/miniforge.sh && \
    bash /tmp/miniforge.sh -b -p $CONDA_DIR && \
    rm /tmp/miniforge.sh
ENV PATH=$CONDA_DIR/bin:$PATH

RUN apt-get install -y

# Install dos2unix
RUN apt-get update && apt-get install -y dos2unix && rm -rf /var/lib/apt/lists/*

# RUN git clone https://github.com/cfsengineering/CEASIOMpy.git
COPY . /CEASIOMpy

# Fix line endings and permissions in one go
RUN find /CEASIOMpy/installation -name "*.sh" -type f -exec dos2unix {} \;

WORKDIR /CEASIOMpy/installation/Ubuntu
RUN chmod +x install_*.sh

WORKDIR /CEASIOMpy

RUN bash installation/Ubuntu/install_openvsp.sh
RUN bash installation/Ubuntu/install_pentagrow.sh
RUN bash installation/Ubuntu/install_su2_with_mpi.sh
RUN bash installation/Ubuntu/install_pyavl.sh

# Install xvfb and other graphical display dependencies for Ubuntu
RUN apt-get update && apt-get install -y --no-install-recommends \
    xvfb libgl1 libglu1-mesa libegl1 libosmesa6 libxt6 && \
    rm -rf /var/lib/apt/lists/*

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    g++ libtbbmalloc2 libtbb-dev libxrender1 libxcursor1 libxinerama1 libxft2 libxt6 \
    libglu1-mesa libosmesa6 xvfb && \
    rm -rf /var/lib/apt/lists/*

# Set the DISPLAY environment variable
ENV DISPLAY=:99
ENV LIBGL_ALWAYS_SOFTWARE=1

# Error rendering
ENV XDG_RUNTIME_DIR=/tmp/runtime-root
RUN mkdir -p /tmp/runtime-root && chmod 700 /tmp/runtime-root

# Set the working directory to the mounted CEASIOMpy folder
WORKDIR /CEASIOMpy

# Create the Conda environment from the local environment.yml file
RUN /bin/bash -c "source $CONDA_DIR/etc/profile.d/conda.sh && conda update -n base -c conda-forge conda -y && conda env create -f environment.yml"

SHELL ["/bin/bash", "-lc"]

# Install CEASIOMpy into the conda environment
RUN source "$CONDA_DIR/etc/profile.d/conda.sh" \
    && conda activate ceasiompy \
    && pip install -e .

# Automatically activate the Conda environment and start GUI in bash
RUN echo "source $CONDA_DIR/etc/profile.d/conda.sh" >> /root/.bashrc && \
    echo "conda activate ceasiompy" >> /root/.bashrc && \
    echo "ceasiompy_run --gui" >> /root/.bashrc

CMD ["bash"]
